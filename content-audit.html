<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Audit - Sanity vs Page</title>
    <style>
        body { font-family: system-ui; padding: 20px; background: #f5f5f5; }
        .audit-panel { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 10px 0; }
        .sanity-content, .page-content { padding: 10px; border-radius: 4px; }
        .sanity-content { background: #e8f5e8; border-left: 4px solid #28a745; }
        .page-content { background: #f8f9fa; border-left: 4px solid #6c757d; }
        .match { background: #d4edda !important; border-left-color: #28a745 !important; }
        .mismatch { background: #f8d7da !important; border-left-color: #dc3545 !important; }
        h3 { margin: 0 0 10px 0; font-size: 14px; font-weight: bold; }
        .status { padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: bold; }
        .status.match { background: #28a745; color: white; }
        .status.mismatch { background: #dc3545; color: white; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        pre { font-size: 12px; margin: 5px 0; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>üîç Content Audit: Sanity vs Live Page</h1>

    <button onclick="runFullAudit()">Run Complete Audit</button>
    <button onclick="testContentInjection()">Test Content Injection</button>

    <div id="audit-results"></div>

    <script type="module">
        const SANITY_CONFIG = { projectId: 'ojsvc60h', dataset: 'production' };

        async function sanityQuery(query) {
            const url = `https://${SANITY_CONFIG.projectId}.api.sanity.io/v2021-10-21/data/query/${SANITY_CONFIG.dataset}?query=${encodeURIComponent(query)}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            return data.result;
        }

        async function getPageContent() {
            const response = await fetch('http://127.0.0.1:3010');
            const html = await response.text();

            // Extract content using regex (same as before)
            const extractText = (regex, html) => {
                const match = html.match(regex);
                return match ? match[1].replace(/<[^>]+>/g, ' ').trim() : null;
            };

            return {
                heroTitle: extractText(/<h1[^>]*hero-card__title[^>]*>(.*?)<\/h1>/s, html),
                heroText: extractText(/id="hero-supporting-text"[^>]*>(.*?)<\/p>/s, html),
                heroCTA: extractText(/<a[^>]*btn--primary[^>]*>([^<]+)<\/a>/, html),
                missionStatement: extractText(/font-family: var\\(--font-heading\\)[^>]*>(.*?)<\/p>/s, html),
                cardTitles: [...html.matchAll(/<div class="heading"[^>]*>\\s*([^<]+)\\s*<\/div>/g)].map(m => m[1].trim()),
                cardDescriptions: [...html.matchAll(/<p style="font-family: 'ibm-plex-mono'[^>]*>([^<]+)<\/p>/g)].map(m => m[1].trim())
            };
        }

        async function getSanityContent() {
            const [hero, cards, copyBlock, marquee] = await Promise.all([
                sanityQuery('*[_type=="hero"][0]{headline, subheadline, ctaButtonCopy, "heroImageUrl": heroImage.asset->url}'),
                sanityQuery('*[_type=="card"][0]{cards[]{headline, subheadline, "imageUrl": image.asset->url}}'),
                sanityQuery('*[_type=="copyBlock"][0]{content}'),
                sanityQuery('*[_type=="marqueeSection"][0]{title, subtitle, quotes[]->{compound, quote, scientist, organization, source}}')
            ]);

            return {
                hero,
                cards: cards?.cards || [],
                copyBlock,
                marquee
            };
        }

        function createComparison(label, sanityValue, pageValue) {
            const isMatch = sanityValue === pageValue;
            const status = isMatch ? 'match' : 'mismatch';
            const statusText = isMatch ? 'MATCH' : 'MISMATCH';

            return `
                <div class="audit-panel">
                    <h2>${label} <span class="status ${status}">${statusText}</span></h2>
                    <div class="comparison">
                        <div class="sanity-content ${status}">
                            <h3>üì¶ Sanity Content</h3>
                            <pre>${sanityValue || 'NULL'}</pre>
                        </div>
                        <div class="page-content ${status}">
                            <h3>üåê Page Content</h3>
                            <pre>${pageValue || 'NULL'}</pre>
                        </div>
                    </div>
                </div>
            `;
        }

        window.runFullAudit = async function() {
            const resultsEl = document.getElementById('audit-results');
            resultsEl.innerHTML = '<p>Running audit...</p>';

            try {
                const [sanityContent, pageContent] = await Promise.all([
                    getSanityContent(),
                    getPageContent()
                ]);

                let html = '';

                // Hero comparisons
                html += createComparison('Hero Title', sanityContent.hero?.headline, pageContent.heroTitle);
                html += createComparison('Hero Text', sanityContent.hero?.subheadline, pageContent.heroText);
                html += createComparison('Hero CTA', sanityContent.hero?.ctaButtonCopy, pageContent.heroCTA);

                // Mission statement
                html += createComparison('Mission Statement', sanityContent.copyBlock?.content, pageContent.missionStatement);

                // Cards
                sanityContent.cards.forEach((card, i) => {
                    html += createComparison(`Card ${i+1} Title`, card.headline, pageContent.cardTitles[i]);
                    html += createComparison(`Card ${i+1} Description`, card.subheadline, pageContent.cardDescriptions[i]);
                });

                // Summary
                const mismatches = html.split('mismatch').length - 1;
                const total = html.split('audit-panel').length - 1;
                const matches = total - mismatches;

                html = `
                    <div class="audit-panel">
                        <h2>üìä Summary</h2>
                        <p><strong>${matches}/${total}</strong> content items match between Sanity and page</p>
                        <p><strong>${mismatches}</strong> mismatches found</p>
                    </div>
                ` + html;

                resultsEl.innerHTML = html;

            } catch (error) {
                resultsEl.innerHTML = `<div class="audit-panel"><h2>‚ùå Error</h2><p>\${error.message}</p></div>`;
            }
        };

        window.testContentInjection = async function() {
            try {
                const { fetchHomepageContent } = await import('/src/js/cms/httpSanity.js');
                const content = await fetchHomepageContent();

                const resultsEl = document.getElementById('audit-results');
                resultsEl.innerHTML = `
                    <div class="audit-panel">
                        <h2>üß™ Content Injection Test</h2>
                        <p><strong>Status:</strong> ‚úÖ Import successful</p>
                        <h3>Fetched Content:</h3>
                        <pre>${JSON.stringify(content, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                const resultsEl = document.getElementById('audit-results');
                resultsEl.innerHTML = `
                    <div class="audit-panel">
                        <h2>üß™ Content Injection Test</h2>
                        <p><strong>Status:</strong> ‚ùå Failed</p>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        };
    </script>
</body>
</html>